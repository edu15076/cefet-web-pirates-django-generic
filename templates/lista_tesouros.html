{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>Gerenciador de Tesouros </h1>
  <a id="logout" href="{% url "logout" %}">
    {% if user.is_authenticated %}
        Log out
    {% else %}
        Log in
    {% endif %}
  </a>
  <section id="tesouros">
    <table>
      <caption>Estes são os tesouros acumulados do Barba-Ruiva em suas aventuras</caption>
      <thead>
        <tr>
          <th>Tesouro</th>
          <th>Nome</th>
          <th>Valor unitário</th>
          <th>Quantidade</th>
          <th>Valor total</th>
          <th colspan="2"></th>
        </tr>
      </thead>
      <tbody>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">Total geral</td>
          <td id="total-geral"></td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
    <a id="inserir" href="{% url "inserir" %}" class="add">+</a>
  </section>
  <p>
      Yarr Harr, marujo! Aqui é o temido Barba-Ruiva e você deve me ajudar
      a contabilizar os espólios das minhas aventuras!
  </p>
    <input type="hidden" value="3">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script>
        // https://docs.djangoproject.com/en/3.2/ref/csrf/#acquiring-the-token-if-csrf-use-sessions-and-csrf-cookie-httponly-are-false
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function excluirTesouro(id) {
            $.ajax({
                type: 'POST',
                url: `/remover/${id}/`,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            });
        }

        function excluirTesourosOnclick() {
            let excluirBtns = document.querySelectorAll('.excluir button');

            for (let excluirBtnEl of excluirBtns)
                excluirBtnEl.onclick = e => {
                    let currentDelEl = e.currentTarget.parentElement;
                    let id = currentDelEl.firstElementChild.value;
                    let currentTreasureEl = currentDelEl.parentElement;
                    let totalGeralEl = document.getElementById('total-geral');
                    let valorTotal = parseFloat(totalGeralEl.innerHTML);
                    totalGeralEl.innerHTML = `${valorTotal - parseFloat(currentTreasureEl.children.item(4).innerHTML)}`;
                    currentTreasureEl.remove();

                    excluirTesouro(id);
                }
        }

        function listTreasures() {
            $.ajax({
                type: 'GET',
                url: '{% url "listar" %}',
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },

                success: request => {
                    $('#total-geral').html(request.pop().total_geral);
                    let treasureTableEl = document.getElementsByTagName('tbody')[0];
                    treasureTableEl.innerHTML = '';
                    for (let tesouro of request) console.log(tesouro)
                    for (let tesouro of request)
                        treasureTableEl.innerHTML += `<tr>
                                                          <td><img src="media/${tesouro.img_tesouro}"></td>
                                                          <td>${tesouro.nome}</td>
                                                          <td>${tesouro.preco}</td>
                                                          <td>${tesouro.quantidade}</td>
                                                          <td>${parseFloat(tesouro.valor_total)}</td>
                                                          <td>
                                                              <a href="/editar/${tesouro.id}/">
                                                                  <img src="{% static 'imgs/edit.png' %}" alt="Editar">
                                                              </a>
                                                          </td>
                                                          <td class="excluir">
                                                              <input type="hidden" value="${tesouro.id}">
                                                              <button>
                                                                  <img src="{% static "imgs/delete.svg" %}" alt="Deletar">
                                                              </button>
                                                          </td>
                                                    </tr>`;
                    excluirTesourosOnclick();
                }
            });
        }

        $(document).ready(() => {
            listTreasures();
        });

    </script>

{% endblock %}
